<div metal:use-macro="_LAYOUT">
<div metal:fill-slot="content">


  <script>
    $(function() {
        $(".requeue").on("click", function(event) {
            if (confirm("Are you sure you want to requeue this submission?")) {
                $.ajax({url: window.url, type: 'put', complete: handle_response});
            }
        });
    });
  </script>


  <!-- Determining the next user/submission -->
  <div tal:condition="prev_next">
    <hr />
    <div tal:replace="structure prev_next"></div>
    <hr />
  </div>

  <fieldset tal:condition="flash">
    <legend>Status Messages</legend>
    <p tal:repeat="msg flash">${msg}</p>
  </fieldset>

  <h3>Submission</h3>
  <div>User: ${submission.user.name} &lt;${submission.user.username}&gt;</div>
  <div>Class: ${submission.project.klass.name}</div>
  <div>Project: ${submission.project.name}</div>
  <div>Submitted: ${submission.created_at}</div>

  <h4>Submission Files</h4>
  <ul tal:condition="submission.files">
    <li tal:repeat="f sorted(submission.files, key=lambda x:x.filename)">
      <a href="${_R('file_item', sha1sum=f.file.sha1, filename=f.filename)}">${f.filename}</a>
    </li>
  </ul>

  <div tal:condition="request.user.is_admin">
    <h3>Admin only debugging information</h3>
    <pre>${submission.verification_results}</pre>
  </div>

  <p tal:condition="not submission.verified_at">
    The submission is still being verified.
  </p>

  <!-- Verification results block -->
  <div tal:condition="submission.verified_at and submission.had_verification_problems()">
    <p>Your submission had files that were problematic. <span style="color:red">Red</span> indicates errors, and <span style="color:yellow">yellow</span> indicates warnings.</p>
    <ul>
      <li tal:repeat="file sorted(verification.keys())">
	<b>${file}</b>
	<ul>
	  <li tal:repeat="warning verification[file][0]">
	    <span style="color:yellow">${warning}</span>
	  </li>
	  <li tal:repeat="error verification[file][1]">
	    <span style="color:red">${error}</span>
	  </li>
	</ul>
      </li>
    </ul>
  </div>

  <!-- Tests that are still pending -->
  <div tal:condition="waiting_to_run">
    <h3><span style="color:red">Note:</span>The following test groups are still pending: ${_fp(sum([t.points() for t in waiting_to_run]))}</h3>
    <ul>
      <li tal:repeat="testable sorted(waiting_to_run)">
	${testable.name} ${_fp(testable.points())}
      </li>
    </ul>
  </div>

  <!-- Test case summary block -->
  <div tal:condition="submission.testables_succeeded()"
       tal:replace="structure diff_table"></div>

  <!-- For each test group, reasons for failure (if applicable) -->
  <div tal:repeat="status sorted(submission.testable_statuses(), key=lambda x: x.testable.name)">
    <div tal:condition="status.is_error()">
      <h3 style="color:red">Test group &ldquo;${status.testable.name}&rdquo; failed to run ${_fp(status.testable.points())}</h3>
      <pre tal:condition="status.has_make_output()">
	${status.testable_results.make_results}
      </pre>
      <p tal:condition="not status.has_files()">
	There are no files in this test group
      </p>
      <ul tal:condition="status.has_files()">
	<li tal:repeat="(file, warnerr) status.sorted_files_to_warnings_errors()">
	  <b>${file}</b>
	  <ul>
	    <li style="color:yellow" tal:repeat="warning warnerr[0]">
	      ${warning}
	    </li>
	    <li style="color:red" tal:repeat="error warnerr[1]">
	      ${error}
	    </li>
	  </ul>
	</li>
      </ul>
    </div>
  </div>

  <!-- Show the user any extra filenames that were submitted -->
  <div tal:condition="extra_files">
    <hr />
    <h3>Extra files that were submitted</h3>
    <ul>
      <li tal:repeat="file extra_files">
	${file}
      </li>
    </ul>
  </div>

  <div tal:condition="submission_admin">
    <input type="button" value="requeue" class="requeue" />
    <!-- Download a submission -->
    <a href="${_R('zipfile_download', submission_id=submission.id)}">Download submission zipfile</a>
  </div>
</div>
</div>
